<!DOCTYPE html []>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="author" content="MarkdownViewer++" />
    <title>build-me.md</title>
    <style type="text/css">
            
/* Avoid page breaks inside the most common attributes, especially for exports (i.e. PDF) */
td, h1, h2, h3, h4, h5, p, ul, ol, li {
    page-break-inside: avoid; 
}
pre, code { font-size: 0.85em; font-family: Consolas, Inconsolata, Courier, monospace; } code { margin: 0 0.15em; padding: 0 0.3em; white-space: pre-wrap; border: 1px solid #EAEAEA; background-color: #F8F8F8; border-radius: 3px; display: inline; /* added to fix Yahoo block display of inline code */ } pre { font-size: 1em; line-height: 1.2em; } pre code { white-space: pre; overflow: auto; border-radius: 3px; border: 1px solid #CCC; padding: 0.5em 0.7em; display: block !important; } .markdown-here-wrapper[data-md-url*="wordpress."] code span { font: inherit; } .markdown-here-wrapper[data-md-url*="wordpress."] pre { background-color: transparent; } p { margin: 0 0 1.2em 0 !important; } table, pre, dl, blockquote, q, ul, ol { margin: 1.2em 0; } ul, ol { padding-left: 2em; } li { margin: 0.5em 0; font-size: 16px; } li p { margin: 0.5em 0 !important; } ul ul, ul ol, ol ul, ol ol { margin: 0; padding-left: 1em; } ul ul, ul, ul { list-style-type: square; font-size: 16px; } ol ol, ul ol { list-style-type: lower-roman; } ul ul ol, ul ol ol, ol ul ol, ol ol ol { list-style-type: lower-alpha; } dl { padding: 0; } dl dt { font-size: 1em; font-weight: bold; font-style: italic; } dl dd { margin: 0 0 1em; padding: 0 1em; } blockquote, q { border-left: 4px solid #DDD; padding: 0 1em; color: #777; quotes: none; } blockquote::before, blockquote::after, q::before, q::after { content: none; } h1, h2, h3, h4, h5, h6{margin:20px 0 10px; padding:0; font-weight: bold; color:#009688;} h1{font-size:24px; border-bottom:1px solid #ddd;} h2{font-size:22px; border-bottom:1px solid #eee;} h3{font-size:20px;} h4{font-size:18px;} h5{font-size:16px;} h6{font-size:16px; color:#777;} table { padding: 0; border-collapse: collapse; border-spacing: 0; font-size: 1em; font: inherit; border: 0; } tbody { margin: 0; padding: 0; border: 0; } table tr { border: 0; border-top: 1px solid #CCC; background-color: white; margin: 0; padding: 0; } table tr:nth-child(2n) { background-color: #F8F8F8; } table tr th, table tr td { font-size: 1em; border: 1px solid #CCC; margin: 0; padding: 0.5em 1em; } table tr th { font-weight: bold; background-color: #F0F0F0; } p { font-size: 16px; line-height: 1.75em; padding-right: 0.5em; padding-left: 0.5em; } strong, b{color:#BF360C;}
        </style>
  </head>
  <body>
    <h2 id="cygwin-get-and-configure-the-cygwin">1. 获取并配置Cygwin / Get and configure the Cygwin</h2>
    <ul>
      <li>下载 <a href="http://www.cygwin.com/setup-x86_64.exe">http://www.cygwin.com/setup-x86_64.exe</a> 并安装</li>
      <li>然后通过<code>cygwin</code>包管理器添加如下包</li>
    </ul>
    <blockquote>
      <table>
        <thead>
          <tr>
            <th style="text-align: left;">Binary-Name </th>
            <th style="text-align: left;">Category </th>
            <th style="text-align: left;">Package </th>
            <th style="text-align: left;">Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="text-align: left;">ar.exe</td>
            <td style="text-align: left;">Devel</td>
            <td style="text-align: left;">binutils</td>
            <td style="text-align: left;">The GNU assembler, linker and binary utilities</td>
          </tr>
          <tr>
            <td style="text-align: left;">make.exe</td>
            <td style="text-align: left;">Devel</td>
            <td style="text-align: left;">make</td>
            <td style="text-align: left;">The GNU version of the 'make' utility built for CYGWIN</td>
          </tr>
          <tr>
            <td style="text-align: left;">m4.exe</td>
            <td style="text-align: left;">Interpreters </td>
            <td style="text-align: left;">m4</td>
            <td style="text-align: left;">GNU implementation of the traditional Unix macro processor</td>
          </tr>
          <tr>
            <td style="text-align: left;">cpio.exe</td>
            <td style="text-align: left;">Utils</td>
            <td style="text-align: left;">cpio</td>
            <td style="text-align: left;">A program to manage archives of files</td>
          </tr>
          <tr>
            <td style="text-align: left;">gawk.exe</td>
            <td style="text-align: left;">Utils</td>
            <td style="text-align: left;">awk</td>
            <td style="text-align: left;">Pattern-directed scanning and processing language</td>
          </tr>
          <tr>
            <td style="text-align: left;">file.exe</td>
            <td style="text-align: left;">Utils</td>
            <td style="text-align: left;">file</td>
            <td style="text-align: left;">Determines file type using 'magic' numbers</td>
          </tr>
          <tr>
            <td style="text-align: left;">zip.exe</td>
            <td style="text-align: left;">Archive</td>
            <td style="text-align: left;">zip</td>
            <td style="text-align: left;">Package and compress (archive) files</td>
          </tr>
          <tr>
            <td style="text-align: left;">unzip.exe</td>
            <td style="text-align: left;">Archive</td>
            <td style="text-align: left;">unzip</td>
            <td style="text-align: left;">Extract compressed files in a ZIP archive</td>
          </tr>
          <tr>
            <td style="text-align: left;">free.exe</td>
            <td style="text-align: left;">System</td>
            <td style="text-align: left;">procps</td>
            <td style="text-align: left;">Display amount of free and used memory in the system</td>
          </tr>
        </tbody>
      </table>
    </blockquote>
    <h2 id="get-the-source-code">2. 获取源码 / Get the source code</h2>
    <ul>
      <li>在<code>cygwin</code>命令行中，通过<code>mkdir</code>创建目录<code>&lt;work dir&gt;</code>，并进入该目录</li>
      <li>在<code>cygwin</code>命令行中，执行如下命令
<pre><code>  hg clone http://hg.openjdk.java.net/jdk8/jdk8 &lt;name&gt;
  cd &lt;name&gt;
  bash ./get_source.sh
</code></pre></li>
    </ul>
    <h2 id="avoid-blank-spaces-in-paths">3. 规避路径中的空格 / Avoid blank spaces in paths</h2>
    <ul>
      <li>
        <p>对路径中含有空格的目录创建软链接</p>
        <pre>
          <code>  D:\VS        &lt;---&gt; D:\Program Files (x86)\Microsoft Visual Studio
  D:\WinKits   &lt;---&gt; D:\Windows Kits
  D:\Java      &lt;---&gt; D:\Program Files\Java
  D:\Mercurial &lt;---&gt; D:\Program Files (x86)\Mercurial
</code>
        </pre>
      </li>
      <li>
        <p>配置<code>JAVA_HOME</code>指向不带空格的软链接路径</p>
      </li>
      <li>
        <p>修改<code>D:\Program Files (x86)\Microsoft Visual Studio\2017\Community\Common7\Tools\vsdevcmd\core\winsdk.bat</code>，
使其获取到的<code>WindowsSdkDir</code>为不含空格的软链接路径</p>
      </li>
    </ul>
    <h2 id="freetype-get-and-compile-freetype">4. 获取并编译Freetype / Get and compile Freetype</h2>
    <ul>
      <li>下载最新版freetype源码 <a href="https://sourceforge.net/projects/freetype/files/freetype2/">https://sourceforge.net/projects/freetype/files/freetype2/</a>，进入目录<code>freetype-x.x.x\builds\windows\vc2010</code>，分别编译动态链接库dll及静态库lib</li>
      <li>在<code>freetype-x.x.x</code>下创建目录<code>lib</code></li>
      <li>编译好的<code>freetype.dll</code>及<code>freetype.lib</code>在<code>freetype-x.x.x\objs</code>目录下，将它们复制到刚刚创建的<code>freetype-x.x.x\lib</code>目录下</li>
      <li>配置环境变量<code>FREETYPE_CFLAGS=...\freetype-x.x.x\include</code>，<code>FREETYPE_LIBS=...\freetype-x.x.x\lib</code>，并在环境变量<code>Path</code>中引入它们（<code>%FREETYPE_CFLAGS%;%FREETYPE_LIBS%</code>）</li>
    </ul>
    <h2 id="configure-configure-jdk8">5. 执行configure脚本 / Configure JDK8</h2>
    <ul>
      <li>
        <p>用<code>cygwin bash</code>打开jdk8目录，执行<code>configure</code>脚本，指定<code>Freetype</code>目录、目标位元、<code>Visual Studio</code>目录，并启用调试，例如:</p>
        <pre>
          <code>  ./configure --with-freetype=/cygdrive/e/Coding/opensource/freetype-2.10.0 --enable-debug --with-target-bits=64 --with-tools-dir="/cygdrive/d/VS/2017/Community"
</code>
        </pre>
      </li>
      <li>
        <p>按照<code>configure</code>所提示的报错信息修改，作者所作修改如下<code>git diff</code>所示:</p>
        <pre>
          <code>  @@ -16773,17 +16773,17 @@ $as_echo "no" &gt;&amp;6; }
     # First-hand choice is to locate and run the vsvars bat file.

     if test "x$OPENJDK_TARGET_CPU_BITS" = x32; then
  -    VCVARSFILE="vc/bin/vcvars32.bat"
  +    VCVARSFILE="VC/Auxiliary/Build/vcvars32.bat"
     else
  -    VCVARSFILE="vc/bin/amd64/vcvars64.bat"
  +    VCVARSFILE="VC/Auxiliary/Build/vcvars64.bat"
     fi

     VS_ENV_CMD=""
     VS_ENV_ARGS=""
  -  if test "x$with_toolsdir" != x; then
  +  if test "x$with_tools_dir" != x; then

     if test "x$VS_ENV_CMD" = x; then
  -    VS100BASE="$with_toolsdir/../.."
  +    VS100BASE="$with_tools_dir"
  	 METHOD="--with-tools-dir"

     windows_path="$VS100BASE"
</code>
        </pre>
        <pre>
          <code>  @@ -16811,7 +16811,7 @@ $as_echo "$as_me: Warning: $VCVARSFILE is missing, this is probably Visual Studi

     fi

  -  if test "x$with_toolsdir" != x &amp;&amp; test "x$VS_ENV_CMD" = x; then
  +  if test "x$with_tools_dir" != x &amp;&amp; test "x$VS_ENV_CMD" = x; then
  	 # Having specified an argument which is incorrect will produce an instant failure;
  	 # we should not go on looking
  	 { $as_echo "$as_me:${as_lineno-$LINENO}: The path given by --with-tools-dir does not contain a valid Visual Studio installation" &gt;&amp;5
</code>
        </pre>
        <pre>
          <code>  @@ -20037,9 +20037,9 @@ $as_echo "$as_me: The result from running with -V was: \"$COMPILER_VERSION_TEST\
  	 # First line typically looks something like:
  	 # Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 16.00.40219.01 for 80x86
  	 COMPILER_VERSION_TEST=`$COMPILER 2&gt;&amp;1 | $HEAD -n 1 | $TR -d '\r'`
  -    COMPILER_VERSION=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.*Version \([1-9][0-9.]*\) .*/\1/p"`
  +    COMPILER_VERSION=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.* \([1-9][0-9.]*\) .*/\1/p"`
  	 COMPILER_VENDOR="Microsoft CL.EXE"
  -    COMPILER_CPU_TEST=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.* for \(.*\)$/\1/p"`
  +    COMPILER_CPU_TEST=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.* \([x8064]*\) .*/\1/p"`
  	 if test "x$OPENJDK_TARGET_CPU" = "xx86"; then
  	   if test "x$COMPILER_CPU_TEST" != "x80x86"; then
  		 as_fn_error $? "Target CPU mismatch. We are building for $OPENJDK_TARGET_CPU but CL is for \"$COMPILER_CPU_TEST\"; expected \"80x86\"." "$LINENO" 5
</code>
        </pre>
        <pre>
          <code>  @@ -21616,9 +21616,9 @@ $as_echo "$as_me: The result from running with -V was: \"$COMPILER_VERSION_TEST\
  	 # First line typically looks something like:
  	 # Microsoft (R) 32-bit C/C++ Optimizing Compiler Version 16.00.40219.01 for 80x86
  	 COMPILER_VERSION_TEST=`$COMPILER 2&gt;&amp;1 | $HEAD -n 1 | $TR -d '\r'`
  -    COMPILER_VERSION=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.*Version \([1-9][0-9.]*\) .*/\1/p"`
  +    COMPILER_VERSION=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.* \([1-9][0-9.]*\) .*/\1/p"`
  	 COMPILER_VENDOR="Microsoft CL.EXE"
  -    COMPILER_CPU_TEST=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.* for \(.*\)$/\1/p"`
  +    COMPILER_CPU_TEST=`$ECHO $COMPILER_VERSION_TEST | $SED -n "s/^.* \([x8064]*\) .*/\1/p"`
  	 if test "x$OPENJDK_TARGET_CPU" = "xx86"; then
  	   if test "x$COMPILER_CPU_TEST" != "x80x86"; then
  		 as_fn_error $? "Target CPU mismatch. We are building for $OPENJDK_TARGET_CPU but CL is for \"$COMPILER_CPU_TEST\"; expected \"80x86\"." "$LINENO" 5
</code>
        </pre>
      </li>
    </ul>
    <h2 id="make">6. 编译 / Make</h2>
    <ul>
      <li>
        <p>添加VC编译工具的<code>Path</code>环境变量，例如：<br /><code>D:\VS\2017\Community\VC\Tools\MSVC\14.16.27023\bin\Hostx64\x64</code></p>
      </li>
      <li>
        <p>修改<code>jdk8\hotspot\make\windows\get_msc_ver.sh</code>，在脚本开头添加:</p>
        <pre>
          <code>  FORCE_MSC_VER=1700
  FORCE_LD_VER=1100
</code>
        </pre>
      </li>
      <li>
        <p>通过VS自带的脚本启动VS命令行（例如: <code>D:\VS\2017\Community\Common7\Tools\LaunchDevCmd.bat</code>），<code>cd</code>进入jdk根目录下的<code>\hotspot\make\windows</code>目录，设置变量<code>HOTSPOTMKSHOME</code>为<code>Cygwin</code>的bin目录（例如: <code>set HOTSPOTMKSHOME=D:\Lang\cygwin64\bin</code>），然后执行脚本<code>create.bat</code></p>
      </li>
      <li>
        <p>
          <code>create.bat</code>脚本会在jdk根目录下的<code>E:\Coding\opensource\openjdk\jdk8\hotspot\build\vs-amd64</code>生成对应版本的vs项目，通过<code>Visual Studio</code>打开它，然后对弹出的升级提示框选择"确定"升级，然后修改<code>项目属性 -&gt; 配置属性 -&gt; C/C++ -&gt; 将警告视为错误</code>为否。</p>
      </li>
      <li>
        <p>针对错误<code>error C3688</code>，在字符串与宏之间添加空格（<code>see</code><a href="https://msdn.microsoft.com/en-us/library/bb531344.aspx">https://msdn.microsoft.com/en-us/library/bb531344.aspx</a>，<code>section</code> "String literals followed by macros"）。</p>
      </li>
      <li>
        <p>针对错误<code>error C2065 “timezone”: 未声明的标识符</code>，将以下代码（129行）</p>
        <pre>
          <code>  #if defined(_ALLBSD_SOURCE)
    const time_t zone = (time_t) time_struct.tm_gmtoff;
  #else
    const time_t zone = timezone;
  #endif
</code>
        </pre>
        <p>修改为</p>
        <pre>
          <code>  #if defined(_ALLBSD_SOURCE)
    const time_t zone = (time_t) time_struct.tm_gmtoff;
  #else
    #if _MSC_VER &lt; 1900
  	const time_t zone = timezone;
    #else
  	const time_t zone = 0;
  	_get_timezone((long *)&amp;zone);
    #endif
  #endif
</code>
        </pre>
      </li>
      <li>
        <p>编译成功</p>
      </li>
    </ul>
  </body>
</html>
